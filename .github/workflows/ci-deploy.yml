name: ci-deploy

on:
  push:
    branches: [main]
  workflow_dispatch: {}

concurrency:
  group: ci-deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  PHP_VERSION: "8.2"
  NODE_VERSION: "20"
  FRONTEND_BUILD_DIR: bomberos-app/dist/bomberos-app

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, pdo_sqlite

      - name: Install backend dependencies
        run: composer install --no-interaction --prefer-dist
        working-directory: backend-app

      - name: Prepare backend test env
        run: |
          cp .env.example .env
          php -r "file_exists('database/database.sqlite') || touch('database/database.sqlite');"
          php artisan key:generate --ansi
        working-directory: backend-app

      - name: Run backend migrations
        env:
          APP_ENV: testing
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite
        run: php artisan migrate --graceful --ansi --force
        working-directory: backend-app

      - name: Run backend tests
        env:
          APP_ENV: testing
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite
        run: php artisan test --ansi
        working-directory: backend-app

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: bomberos-app/package-lock.json

      - name: Install frontend dependencies
        run: npm ci
        working-directory: bomberos-app

      - name: Run frontend tests
        run: npm test -- --watch=false --browsers=ChromeHeadless
        working-directory: bomberos-app

      - name: Build frontend
        run: npm run build -- --configuration production
        working-directory: bomberos-app
        
      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: ${{ env.FRONTEND_BUILD_DIR }}
      
  deploy:
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout (deploy)
        uses: actions/checkout@v4

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          PORT="${SSH_PORT:-22}"
          ssh-keyscan -p "$PORT" -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Deploy backend (remote)
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          BACKEND_PATH: ${{ secrets.BACKEND_PATH }}
        run: |
          PORT="${SSH_PORT:-22}"
          ssh -p "$PORT" "$SSH_USER@$SSH_HOST" "BACKEND_PATH='$BACKEND_PATH' bash -s" << 'EOF'
          set -euo pipefail
          cd "$BACKEND_PATH/backend-app"
          git pull origin main
          php "$HOME/composer.phar" install --no-dev --no-interaction --prefer-dist --optimize-autoloader
          php artisan migrate --force --ansi
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          EOF

      - name: Deploy frontend (scp)
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          FRONTEND_DEPLOY_PATH: ${{ secrets.FRONTEND_DEPLOY_PATH }}
        run: |
          PORT="${SSH_PORT:-22}"
          ssh -p "$PORT" "$SSH_USER@$SSH_HOST" "rm -rf '$FRONTEND_DEPLOY_PATH' && mkdir -p '$FRONTEND_DEPLOY_PATH'"
          scp -P "$PORT" -r dist/* "$SSH_USER@$SSH_HOST:$FRONTEND_DEPLOY_PATH/"
          ssh -p "$PORT" "$SSH_USER@$SSH_HOST" "mkdir -p '$FRONTEND_DEPLOY_PATH/browser'"
          scp -P "$PORT" bomberos-app/public/.htaccess "$SSH_USER@$SSH_HOST:$FRONTEND_DEPLOY_PATH/browser/.htaccess"
