<form [formGroup]="unitForm" (ngSubmit)="onSave()">
  
  <div mat-dialog-title class="dialog-title-container">
    <span class="title-text">{{ isEditMode() ? 'Editar Unidad' : 'Crear Nueva Unidad' }}</span>
    <button
      mat-icon-button
      class="close-button"
      (click)="onCancel()"
      type="button"
      matTooltip="Cerrar"
    >
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div mat-dialog-content class="dialog-content">
    <!-- Nombre de la Unidad -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Nombre de la Unidad (Ej: B6)</mat-label>
      <input matInput formControlName="name" cdkFocusInitial />
      @if (unitForm.get('name')?.hasError('required')) {
      <mat-error>El nombre es obligatorio</mat-error>
      }
    </mat-form-field>

    <!-- Fila 1: Patente y Modelo -->
    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field-half">
        <mat-label>Patente (Ej: KD-VV-46)</mat-label>
        <input matInput formControlName="plate" />
        @if (unitForm.get('plate')?.hasError('required')) {
        <mat-error>La patente es obligatoria</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field-half">
        <mat-label>Modelo</mat-label>
        <input matInput formControlName="model" />
      </mat-form-field>
    </div>

    <!-- Fila 2: Año y Chasis (CORREGIDO a snake_case) -->
    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field-half">
        <mat-label>Año de Fabricación</mat-label>
        <!-- type="number" ayuda a que el input sea numérico -->
        <input matInput type="number" formControlName="manufacturing_year" placeholder="Ej: 2018" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field-half">
        <mat-label>Número de Chasis</mat-label>
        <input matInput formControlName="chassis_number" />
      </mat-form-field>
    </div>

    <!-- Compañía -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Compañía (Ej: 6ta-10ma)</mat-label>
      <input matInput formControlName="company" />
      @if (unitForm.get('company')?.hasError('required')) {
      <mat-error>La compañía es obligatoria</mat-error>
      }
    </mat-form-field>

    <!-- Estado -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Estado Inicial</mat-label>
      <mat-select formControlName="status">
        <mat-option value="En Servicio">
          <mat-icon style="color: #2ecc71; margin-right: 8px">check_circle</mat-icon>
          En Servicio
        </mat-option>
        <mat-option value="En Taller">
          <mat-icon style="color: #f39c12; margin-right: 8px">build</mat-icon>
          En Taller
        </mat-option>
        <mat-option value="Fuera de Servicio">
          <mat-icon style="color: #e74c3c; margin-right: 8px">block</mat-icon>
          Fuera de Servicio
        </mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Sección de Imagen -->
    <div class="image-upload-section">
      @if (currentImageUrl() && !selectedImageName()) {
        <div class="current-image-preview">
          <p class="preview-label">Imagen Actual:</p>
          <img [src]="currentImageUrl()" alt="Foto actual" class="preview-thumbnail">
        </div>
      }

      <input
        type="file"
        #imageInput
        hidden
        (change)="onImageSelected($event)"
        accept="image/png, image/jpeg, image/webp"
      />

      <button 
        mat-stroked-button 
        type="button" 
        (click)="imageInput.click()" 
        class="file-button"
        color="primary">
        <mat-icon>upload_file</mat-icon>
        {{ isEditMode() ? 'Cambiar Foto' : 'Subir Foto (Opcional)' }}
      </button>

      @if (selectedImageName()) {
      <div class="file-name-container">
        <mat-icon class="new-file-icon">image</mat-icon>
        <div class="file-info">
          <span class="file-label-new">Nueva imagen seleccionada:</span>
          <span class="file-name">{{ selectedImageName() }}</span>
        </div>
        <button mat-icon-button color="warn" (click)="onRemoveNewImage()" type="button" matTooltip="Cancelar subida">
            <mat-icon>close</mat-icon>
        </button>
      </div>
      }
    </div>
  </div>

  <div mat-dialog-actions class="dialog-actions" align="end">
    <button mat-stroked-button (click)="onCancel()" type="button">Cancelar</button>
    <button mat-flat-button color="primary" type="submit" [disabled]="unitForm.invalid">
      {{ isEditMode() ? 'Actualizar Unidad' : 'Guardar Unidad' }}
    </button>
  </div>
</form>