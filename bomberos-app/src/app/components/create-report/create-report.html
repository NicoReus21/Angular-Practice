<form [formGroup]="reportForm">
  <h1 mat-dialog-title class="dialog-title-container">
    <span class="title-text">{{ dialogTitle }}</span>
    <button
      mat-icon-button
      class="close-button"
      (click)="onCancel()"
      type="button"
      matTooltip="Cerrar"
    >
      <mat-icon>close</mat-icon>
    </button>
  </h1>

  <div mat-dialog-content class="dialog-content">
    <h3 class="section-title">Información de la Unidad</h3>
    <!-- Fila 1: Modelo, Patente, Compañía -->
    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field-third">
        <mat-label>Modelo</mat-label>
        <input matInput formControlName="model" />
      </mat-form-field>
      <mat-form-field appearance="outline" class="form-field-third">
        <mat-label>Patente</mat-label>
        <input matInput formControlName="plate" />
      </mat-form-field>
      <mat-form-field appearance="outline" class="form-field-third">
        <mat-label>Compañía</mat-label>
        <input matInput formControlName="company" />
      </mat-form-field>
    </div>

    <!-- Fila 2: Año y Chasis (Corregido a snake_case para coincidir con TS) -->
    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field-half">
        <mat-label>Año Fabricación</mat-label>
        <input matInput formControlName="manufacturing_year" />
      </mat-form-field>
      <mat-form-field appearance="outline" class="form-field-half">
        <mat-label>N° Chasis</mat-label>
        <input matInput formControlName="chassis_number" />
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field-half">
        <mat-label>Kilometraje</mat-label>
        <input matInput formControlName="mileage" type="number" required />
        <mat-error>Requerido</mat-error>
      </mat-form-field>
    </div>

    <mat-divider class="section-divider"></mat-divider>

    <h3 class="section-title">Detalles de Inspección</h3>
    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field-third">
        <mat-label>Cabina</mat-label>
        <input matInput formControlName="cabin" />
      </mat-form-field>
      <mat-form-field appearance="outline" class="form-field-third">
        <mat-label>Filtros (Código)</mat-label>
        <input matInput formControlName="filter_code" />
      </mat-form-field>
      <mat-form-field appearance="outline" class="form-field-third">
        <mat-label>Horómetro</mat-label>
        <input matInput formControlName="hourmeter" />
      </mat-form-field>
    </div>
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Señales de Advertencia</mat-label>
      <textarea matInput formControlName="warnings" rows="2"></textarea>
    </mat-form-field>

    <mat-divider class="section-divider"></mat-divider>

    <h3 class="section-title">Detalles del Servicio</h3>
    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field-third">
        <mat-label>Tipo de Servicio</mat-label>
        <mat-select formControlName="service_type" required>
          <mat-option value="Mantención Preventiva">M. Preventiva</mat-option>
          <mat-option value="Mantención Correctiva">M. Correctiva</mat-option>
          <mat-option value="Revisión General">Rev. General</mat-option>
          <mat-option value="Reparación">Reparación</mat-option>
          <mat-option value="Otros">Otros</mat-option>
        </mat-select>
        <mat-error>Requerido</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field-third">
        <mat-label>Inspector</mat-label>
        <input matInput formControlName="inspector_name" required />
        <mat-error>Requerido</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field-third">
        <mat-label>Fecha</mat-label>
        <input matInput [matDatepicker]="picker" formControlName="service_date" required />
        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
        <mat-error>Requerida</mat-error>
      </mat-form-field>
    </div>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Ubicación del Equipo</mat-label>
      <input matInput formControlName="location" />
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Problema Reportado</mat-label>
      <textarea matInput formControlName="reported_problem" rows="3" required></textarea>
      <mat-error>Requerido</mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Detalle Actividades</mat-label>
      <textarea matInput formControlName="activities_detail" rows="5" required></textarea>
      <mat-error>Requerido</mat-error>
    </mat-form-field>

    <mat-divider class="section-divider"></mat-divider>

    <h3 class="section-title">Cierre y Pendientes</h3>
    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field-half">
        <mat-label>Trabajo Pendiente</mat-label>
        <textarea matInput formControlName="pending_work" rows="2"></textarea>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field-half">
        <mat-label>Criticidad</mat-label>
        <mat-select formControlName="pending_type">
          <mat-option value="Ninguno">Ninguno</mat-option>
          <mat-option value="Crítico">Crítico</mat-option>
          <mat-option value="Normal">Normal</mat-option>
          <mat-option value="Bajo">Bajo</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Observaciones</mat-label>
      <textarea matInput formControlName="observations" rows="2"></textarea>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Anexo Información</mat-label>
      <textarea matInput formControlName="car_info_annex" rows="2"></textarea>
    </mat-form-field>

    <h3 class="section-title">Firmas Digitales</h3>
    <div class="signatures-container">
      <div class="signature-box">
        <div class="signature-header">
          <label>Firma Inspector</label>
          <button
            mat-icon-button
            color="warn"
            (click)="clearInspectorSignature()"
            matTooltip="Borrar"
            type="button"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </div>

        @if (showSavedInspectorSignature()) {
        <div class="saved-signature-preview">
          <img [src]="reportForm.get('inspector_signature')?.value" alt="Firma Inspector" />
          <span class="saved-label">Guardada</span>
        </div>
        } @else {
        <div class="canvas-wrapper">
          <canvas #inspectorCanvas></canvas>
          <div class="placeholder-text">Inspector firme aquí</div>
        </div>
        }
      </div>

      <div class="signature-box">
        <div class="signature-header">
          <label>Firma Oficial</label>
          <button
            mat-icon-button
            color="warn"
            (click)="clearOfficerSignature()"
            matTooltip="Borrar"
            type="button"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </div>

        @if (showSavedOfficerSignature()) {
        <div class="saved-signature-preview">
          <img [src]="reportForm.get('officer_signature')?.value" alt="Firma Oficial" />
          <span class="saved-label">Guardada</span>
        </div>
        } @else {
        <div class="canvas-wrapper">
          <canvas #officerCanvas></canvas>
          <div class="placeholder-text">Oficial firme aquí</div>
        </div>
        }
      </div>
    </div>

    <div class="file-section">
      @if (existingImages().length > 0) {
      <h4 class="subsection-title">Adjuntos Guardados</h4>
      <mat-list class="file-preview-list">
        @for (img of existingImages(); track img.id) {
        <mat-list-item class="file-preview-item saved-item">
          <mat-icon matListItemIcon>image</mat-icon>
          <div matListItemTitle>{{ img.file_name || img.name || 'Imagen adjunta' }}</div>
          <div matListItemLine>Guardado previamente</div>
          @if (img.previewUrl) {
          <a mat-icon-button [href]="img.previewUrl" target="_blank" matTooltip="Ver imagen">
            <mat-icon>visibility</mat-icon>
          </a>
          }
        </mat-list-item>
        }
      </mat-list>
      <mat-divider class="section-divider"></mat-divider>
      }

      <label for="file-upload" class="file-upload-label">
        <mat-icon>add_photo_alternate</mat-icon>
        Adjuntar Nuevas Fotos
      </label>

      <input
        id="file-upload"
        type="file"
        multiple
        accept="image/*"
        (change)="onFileSelected($event)"
        class="file-input"
        #fileUploadInput
      />

      @if (selectedFiles().length > 0) {
      <mat-list class="file-preview-list">
        @for (file of selectedFiles(); track $index) {
        <mat-list-item class="file-preview-item">
          <mat-icon matListItemIcon>add_a_photo</mat-icon>
          <div matListItemTitle>{{ file.name }}</div>
          <div matListItemLine>{{ file.size / 1024 | number : '1.0-1' }} KB</div>
          <button
            mat-icon-button
            (click)="onRemoveFile(file); fileUploadInput.value = ''"
            type="button"
            color="warn"
          >
            <mat-icon>close</mat-icon>
          </button>
        </mat-list-item>
        }
      </mat-list>
      }
    </div>
  </div>

  <div mat-dialog-actions class="dialog-actions" align="end">
    <button mat-stroked-button (click)="onCancel()" type="button" class="action-btn">
      Cancelar
    </button>
    <button
      mat-button
      color="accent"
      (click)="onSave('draft')"
      type="button"
      class="action-btn draft-btn"
    >
      <mat-icon>save</mat-icon> Guardar Borrador
    </button>
    <button
      mat-flat-button
      color="primary"
      (click)="onSave('completed')"
      type="button"
      class="action-btn"
    >
      <mat-icon>check_circle</mat-icon> Finalizar
    </button>
  </div>
</form>