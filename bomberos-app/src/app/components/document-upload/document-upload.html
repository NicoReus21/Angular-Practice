<div class="upload-container mat-elevation-z4">
  <!-- FORMULARIO PRELIMINAR: Se muestra al inicio en modo creación -->
  <ng-container *ngIf="!preliminaryDataCompleted()">
    <h1 class="page-title">Información del Siniestro</h1>
    <p class="page-subtitle">Ingrese los datos del voluntario antes de iniciar la carga de documentos.</p>
    
    <form [formGroup]="preliminaryForm" (ngSubmit)="submitPreliminaryData()" class="preliminary-form">
      <mat-form-field appearance="outline">
        <mat-label>Nombre del Bombero</mat-label>
        <input matInput formControlName="bomberoNombre">
      </mat-form-field>
      
      <mat-form-field appearance="outline">
        <mat-label>Compañía</mat-label>
        <mat-select formControlName="compania">
          <mat-option *ngFor="let company of fireCompanies" [value]="company">{{company}}</mat-option>
        </mat-select>
      </mat-form-field>
      
      <button mat-flat-button color="warn" type="submit" [disabled]="preliminaryForm.invalid">
        Continuar con la Documentación
      </button>
    </form>
  </ng-container>

  <!-- FLUJO DE CARGA: Se muestra después de completar el form inicial o en modo edición -->
  <ng-container *ngIf="preliminaryDataCompleted()">
    <h1 class="page-title">
      <span *ngIf="editMode()">Editando Documentación</span>
      <span *ngIf="!editMode()">Flujo de Ingreso de Documentos</span>
      <br>{{ preliminaryForm.get('bomberoNombre')?.value }}
    </h1>
    
    <p *ngIf="!editMode()" class="process-message">Siga los pasos para completar el ingreso de documentos.</p>
    
    <div *ngIf="uploadError()" class="error-message">
      <mat-icon>error_outline</mat-icon>
      <span>{{ uploadError() }}</span>
    </div>

    <div *ngIf="flatStepIndex() === allSteps().length" class="completion-message">
        <mat-icon>check_circle</mat-icon>
        <span>¡Proceso completado con éxito! Redirigiendo...</span>
    </div>

    <h2 class="checklist-title">Pasos del Proceso (Checklist)</h2>

    <mat-accordion multi="false">
      <ng-container *ngFor="let section of sections(); let sectionIndex = index">
        <mat-expansion-panel 
          class="section-panel" 
          [expanded]="editMode() || sectionIndex === currentSectionIndex()"
          [disabled]="true">
          
          <mat-expansion-panel-header>
            <mat-panel-title class="section-title">{{ section.title }}</mat-panel-title>
          </mat-expansion-panel-header>

          <div class="checklist">
            <ng-container *ngFor="let step of section.steps; let stepIndex = index">
              <div class="step-item"
                   [class.active]="!editMode() && flatStepIndex() === getFlatIndex(sectionIndex, stepIndex)"
                   [class.completed]="step.isCompleted">

                <div class="step-header">
                  <div class="step-info">
                    <span class="step-number">{{ getFlatIndex(sectionIndex, stepIndex) + 1 }}.</span>
                    <span class="step-title">{{ step.title }}</span>
                    <span *ngIf="step.optional" class="optional-badge">Opcional</span>
                  </div>
                  <mat-icon *ngIf="step.isCompleted" class="completion-icon">check_circle</mat-icon>
                </div>

                <div *ngIf="editMode() || flatStepIndex() === getFlatIndex(sectionIndex, stepIndex)" class="step-content">
                  <div class="drag-area"
                       (click)="fileInput.click()"
                       (dragover)="onDragOver($event)"
                       (dragleave)="onDragLeave($event)"
                       (drop)="onDrop($event, getFlatIndex(sectionIndex, stepIndex))">
                    
                    <ng-container *ngIf="step.files.length === 0; else fileList">
                      <mat-icon>upload</mat-icon>
                      <p>Arrastra y suelta archivos aquí o haz clic para seleccionar</p>
                    </ng-container>
                    <ng-template #fileList>
                      <ul class="file-list">
                        <li *ngFor="let file of step.files">
                            <span>{{ file.name }} ({{ (file.size / 1024).toFixed(2) }} KB)</span>
                            <button mat-icon-button (click)="removeFile(step, file)" class="delete-file-btn" aria-label="Eliminar archivo">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </li>
                      </ul>
                    </ng-template>
                    
                    <input type="file" #fileInput hidden multiple (change)="handleFiles($any($event.target).files, getFlatIndex(sectionIndex, stepIndex))">
                  </div>

                  <mat-checkbox *ngIf="section.title === 'PRESTACIONES MEDICA' && stepIndex === 0 && step.files.length > 0"
                                [checked]="step.isPaid"
                                (change)="togglePaidStatus(step)"
                                class="paid-checkbox">
                    Factura Pagada
                  </mat-checkbox>
                  
                  <div *ngIf="!editMode()" class="action-buttons">
                    <button *ngIf="step.optional" mat-stroked-button (click)="nextStep()">No Aplica</button>
                    <button mat-flat-button color="warn" [disabled]="(!step.optional && step.files.length === 0) || isUploading()" (click)="nextStep()">
                       <span *ngIf="!isUploading()">Listo y Continuar</span>
                       <span *ngIf="isUploading()">Subiendo...</span>
                    </button>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
        </mat-expansion-panel>
      </ng-container>
    </mat-accordion>

    <!-- BOTÓN FINALIZAR: Fuera del acordeón para que siempre sea visible cuando se cumpla la condición -->
    <div *ngIf="!editMode() && requiredStepsCompleted()" class="finish-flow-container">
        <button mat-flat-button color="primary" (click)="finishProcess()">
          <mat-icon>done_all</mat-icon>
          Finalizar Flujo
        </button>
    </div>
    
    <!-- BOTÓN GUARDAR: Se muestra solo en modo edición -->
    <div *ngIf="editMode()" class="finish-flow-container">
        <button mat-flat-button color="primary" (click)="saveChanges()">
          <mat-icon>save</mat-icon>
          Guardar Cambios
        </button>
    </div>
  </ng-container>
</div>

