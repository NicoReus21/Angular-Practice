<section class="user-access">
  <header class="page-header">
    <div>
      <p class="eyebrow">Modulo de autenticacion</p>
      <h1>Gestion de usuario</h1>
      <p class="subtitle">Administra roles, permisos y grupos asignados.</p>
    </div>
    <button mat-stroked-button color="warn" routerLink="/rols">
      <mat-icon>arrow_back</mat-icon>
      Volver
    </button>
  </header>

  @if (isLoading()) {
    <div class="state state--loading">
      <mat-spinner diameter="28"></mat-spinner>
      <p>Cargando informacion del usuario...</p>
    </div>
  } @else if (errorMessage()) {
    <div class="state state--error">
      <mat-icon>error</mat-icon>
      <p>{{ errorMessage() }}</p>
    </div>
  } @else {
    <mat-card class="user-card">
      <mat-card-header>
        <div>
          <mat-card-title>{{ user()?.name }}</mat-card-title>
          <mat-card-subtitle>{{ user()?.email }}</mat-card-subtitle>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div class="user-meta">
          <div>
            <span class="meta-label">Compania</span>
            <span class="meta-value">{{ user()?.company || 'Sin compania' }}</span>
          </div>
          <div>
            <span class="meta-label">Estado</span>
            <span class="meta-value">{{ user()?.status || 'Sin estado' }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <div class="grid">
      <mat-card class="table-card">
        <mat-card-header>
          <div>
            <mat-card-title>Grupos disponibles</mat-card-title>
            <mat-card-subtitle>Selecciona los grupos que quieres asignar.</mat-card-subtitle>
          </div>
        </mat-card-header>
        <mat-card-content>
          @if (!availableGroups().length) {
            <div class="state state--empty">
              <mat-icon>group_off</mat-icon>
              <p>No hay grupos disponibles para asignar.</p>
            </div>
          } @else {
            <div class="group-select">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Selecciona grupos</mat-label>
                <mat-select [formControl]="groupSelect" multiple>
                  @for (group of availableGroups(); track group.id) {
                    <mat-option [value]="group.id">{{ group.name }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
              <button
                mat-flat-button
                color="warn"
                type="button"
                [disabled]="groupSelect.invalid || isAssigningGroups()"
                (click)="assignSelectedGroups()"
              >
                <mat-icon>add</mat-icon>
                {{ isAssigningGroups() ? 'Asignando...' : 'Asignar grupos' }}
              </button>
            </div>
          }
        </mat-card-content>
      </mat-card>

      <mat-card class="table-card">
        <mat-card-header>
          <div>
            <mat-card-title>Grupos asignados</mat-card-title>
            <mat-card-subtitle>Solo se muestra el nombre de los grupos.</mat-card-subtitle>
          </div>
        </mat-card-header>
        <mat-card-content>
          @if (!assignedGroups().length) {
            <div class="state state--empty">
              <mat-icon>group_off</mat-icon>
              <p>El usuario no tiene grupos asignados.</p>
            </div>
          } @else {
            <table class="data-table">
              <thead>
                <tr>
                  <th>Grupo</th>
                </tr>
              </thead>
              <tbody>
                @for (group of assignedGroups(); track group.id) {
                  <tr>
                    <td>{{ group.name }}</td>
                  </tr>
                }
              </tbody>
            </table>
          }
        </mat-card-content>
      </mat-card>

      <mat-card class="table-card">
        <mat-card-header>
          <div>
            <mat-card-title>Roles disponibles</mat-card-title>
            <mat-card-subtitle>Selecciona los roles que quieres asignar.</mat-card-subtitle>
          </div>
        </mat-card-header>
        <mat-card-content>
          @if (!availableRoles().length) {
            <div class="state state--empty">
              <mat-icon>shield</mat-icon>
              <p>No hay roles disponibles para asignar.</p>
            </div>
          } @else {
            <div class="group-select">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Selecciona roles</mat-label>
                <mat-select [formControl]="roleSelect" multiple>
                  @for (role of availableRoles(); track role.id) {
                    <mat-option [value]="role.id">{{ role.name }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
              <button
                mat-flat-button
                color="warn"
                type="button"
                [disabled]="roleSelect.invalid || isAssigningRoles()"
                (click)="assignSelectedRoles()"
              >
                <mat-icon>add</mat-icon>
                {{ isAssigningRoles() ? 'Asignando...' : 'Asignar roles' }}
              </button>
            </div>
          }
        </mat-card-content>
      </mat-card>

      <mat-card class="table-card">
        <mat-card-header>
          <div>
            <mat-card-title>Roles asignados</mat-card-title>
            <mat-card-subtitle>Solo se muestra el nombre del rol.</mat-card-subtitle>
          </div>
        </mat-card-header>
        <mat-card-content>
          @if (!assignedRoles().length) {
            <div class="state state--empty">
              <mat-icon>shield</mat-icon>
              <p>El usuario no tiene roles asignados.</p>
            </div>
          } @else {
            <table class="data-table">
              <thead>
                <tr>
                  <th>Rol</th>
                </tr>
              </thead>
              <tbody>
                @for (role of assignedRoles(); track role.id) {
                  <tr>
                    <td>{{ role.name }}</td>
                  </tr>
                }
              </tbody>
            </table>
          }
        </mat-card-content>
      </mat-card>
    </div>

    <mat-card class="table-card">
      <mat-card-header>
        <div>
          <mat-card-title>Permisos efectivos</mat-card-title>
          <mat-card-subtitle>Permisos heredados por los roles asignados.</mat-card-subtitle>
        </div>
      </mat-card-header>
      <mat-card-content>
        @if (!sortedPermissions().length) {
          <div class="state state--empty">
            <mat-icon>rule</mat-icon>
            <p>No hay permisos asociados.</p>
          </div>
        } @else {
          <table class="data-table">
            <thead>
              <tr>
                <th>Permiso</th>
              </tr>
            </thead>
            <tbody>
              @for (permission of sortedPermissions(); track permission.id) {
                <tr>
                  <td>{{ permission.name }}</td>
                </tr>
              }
            </tbody>
          </table>
        }
      </mat-card-content>
    </mat-card>
  }
</section>
